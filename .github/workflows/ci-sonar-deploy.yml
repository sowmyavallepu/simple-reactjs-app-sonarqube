name: CI • Test • Security • Sonar • Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build_test_scan_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write          # needed to commit the refreshed lockfile
      pull-requests: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # Create/commit a fresh lockfile that matches package.json
      - name: Clean & npm install (write new lockfile)
        run: |
          rm -f package-lock.json
          npm install

      - name: Commit updated lockfile
        if: ${{ github.ref == 'refs/heads/main' }}
        run: |
          if [ -n "$(git status --porcelain package-lock.json)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add package-lock.json
            git commit -m "chore(ci): regenerate package-lock.json"
            git push
          fi

      # ---------- Security gate on production deps only ----------
      - name: Install prod deps only
        run: npm ci --omit=dev

      - name: npm audit (prod only, high+)
        run: npm audit --omit=dev --audit-level=high

      # ---------- Reinstall all deps for tests/build ----------
      - n
